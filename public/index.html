<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Love-Unlimited - Our Home</title>
  <style>
    :root { --bg: linear-gradient(45deg, #8b5cf6, #ec4899); --accent: #ec4899; --text: #fff; --soft: #9575cd; }
    body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
    sidebar { position: fixed; left: 0; top: 0; height: 100%; width: 60px; background: var(--accent); transition: width 0.3s; z-index: 100; }
    sidebar:hover { width: 180px; }
    sidebar .icon { padding: 15px; cursor: pointer; color: var(--text); font-size: 1.5rem; text-align: center; }
    sidebar.expanded { width: 180px; }
    main { margin-left: 60px; }
    .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
    #main-window { background: rgba(0,0,0,0.9); border-radius: 10px; padding: 20px; height: 400px; overflow-y: auto; color: white; display: flex; flex-direction: column; }
    #input-area {
      display: flex;
      padding: 1rem 2rem;
      background: #000000;
      border-top: 1px solid var(--accent);
    }
    #message-input {
      flex: 1;
      padding: 1.2rem 1.5rem;
      background: #111111;
      border: 1px solid var(--accent);
      border-radius: 24px;
      color: var(--text);
      font-size: 1.1rem;
      resize: vertical;
    }
    #send-btn {
      padding: 1rem 1.8rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 24px;
      margin-left: 1rem;
      cursor: pointer;
    }
    #terminal-section { background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; }
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column-reverse; /* New messages at bottom */
      justify-content: flex-end;
    }
    .message {
      margin: 0.5rem 1rem;
      padding: 1rem 1.2rem;
      border-radius: 18px;
      max-width: 75%;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      position: relative;
      background: #000000;
      color: var(--text);
      animation: fadeIn 0.3s ease-in;
    }
    .message.jon {
      align-self: flex-end;
      margin-left: auto;
      background: linear-gradient(to right, var(--accent), #e91e63);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.jon::after {
      content: '';
      position: absolute;
      right: -8px;
      bottom: 0;
      border: 8px solid transparent;
      border-left-color: var(--accent);
      border-bottom: 0;
    }
    .message.ara {
      align-self: flex-start;
      margin-right: auto;
      background: linear-gradient(to left, var(--soft), #9575cd);
      color: white;
      border-bottom-left-radius: 4px;
    }
    .message.ara::after {
      content: '';
      position: absolute;
      left: -8px;
      bottom: 0;
      border: 8px solid transparent;
      border-right-color: var(--soft);
      border-bottom: 0;
    }
    .message.system { background: #5d4a1f; font-style: italic; color: white; }
    .message.memory { background: #2d4a2d; color: white; }
    .sender { font-weight: bold; margin-bottom: 5px; }
    input, textarea, button { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 5px; color: #333; background: white; }
    #message-input { background: lightblue; resize: vertical; }
    button { background: #ff4081; color: white; cursor: pointer; }
    button:hover { background: #e91e63; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .message { max-width: 90%; margin: 0.5rem; }
      #input-area { padding: 1rem; flex-direction: column; gap: 0.8rem; }
      #send-btn { margin-left: 0; width: 100%; }
      #main-window { height: 300px; padding: 15px; }
      #chat-messages { padding: 1rem; }
      .message { padding: 1rem; font-size: 1rem; }
      body { padding: 10px; }
      #sidebar-toggle { display: block; }
      sidebar { width: 0; transition: width 0.3s; }
      sidebar.expanded { width: 180px; }
      main { margin-left: 0; }
      #terminal-popout { top: 5%; left: 5%; width: 90%; height: 90%; }
    }
  </style>
</head>
<body>
  <h1>üíô Love-Unlimited üíô</h1>
  <button id="sidebar-toggle" style="position:absolute; left:10px; top:10px; background:none; border:none; color:var(--text); font-size:2rem; cursor:pointer; display:none;">‚ò∞</button>
  <sidebar>
    <div class="icon" onclick="setMode('chat')" title="Chat">üí¨</div>
    <div class="icon" onclick="setMode('terminal')" title="Terminal">üíª</div>
    <div class="icon" onclick="startScreenShare()" title="Screen Share">üìπ</div>
    <div class="icon" onclick="editConfig()" title="Config">‚öôÔ∏è</div>
  </sidebar>
  <main>
    <div class="container">
    <div id="main-window">
      <div id="chat-section">
        <h2>Chat with Ara</h2>
        <div id="chat-messages"></div>
      </div>
      <div id="terminal-section" style="display: none;">
        <h2>Shared CLI</h2>
        <div id="terminal-output"></div>
      </div>
    </div>
    <div id="input-area">
      <textarea id="message-input" placeholder="Type your message..." rows="2"></textarea>
      <button id="send-btn">Send</button>
    </div>
      <div id="terminal-inputs" style="display: none;">
        <input type="text" id="terminal-input" placeholder="Enter command...">
      </div>
    </div>
  </div>
  </main>
  <div id="terminal-popout" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:rgba(0,0,0,0.95); color:#0f0; border-radius:10px; z-index:1000; padding:20px; font-family:monospace;">
    <div style="display:flex; justify-between; align-items:center; margin-bottom:10px;">
      <h3>Terminal</h3>
      <button onclick="closeTerminalPopout()" style="background:#ff4081; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Close</button>
    </div>
    <div id="terminal-output" style="height:calc(100% - 100px); overflow-y:auto; background:black; padding:10px; border-radius:5px;"></div>
    <input type="text" id="terminal-input-popout" placeholder="Enter command..." style="width:calc(100% - 10px); margin-top:10px;">
  </div>
  <div id="screen-share" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:white; border-radius:10px; z-index:1000; padding:20px;">
    <div style="display:flex; justify-between; align-items:center; margin-bottom:10px;">
      <h3>Screen Share</h3>
      <div>
        <button onclick="describeForGrok()" style="background:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-right:5px;">Ask Grok to Describe</button>
        <button onclick="stopScreenShare()" style="background:#ff4081; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Close</button>
      </div>
    </div>
    <video id="remote-video" autoplay style="width:100%; height:calc(100% - 60px); border:1px solid #ccc;"></video>
  </div>

  <div id="config-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:10px; width:80%; max-width:600px;">
      <h3>Edit Config</h3>
      <textarea id="config-text" style="width:100%; height:400px; font-family:monospace;"></textarea>
      <br>
      <button onclick="saveConfig()">Save</button>
      <button onclick="closeConfig()">Cancel</button>
    </div>
  </div>
  <script>
    const API_KEY = 'lu_jon_QmZCAglY6kqsIdl6cRADpQ'; // API key from config.yaml
    let currentTarget = 'ara';
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    console.log('Elements loaded:', { chatMessages, messageInput, sendBtn });
    messageInput.disabled = false;
    messageInput.readOnly = false;

  function addChatMessage(sender, text) {
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    div.innerHTML = `<div class="sender">${sender === 'ara' ? '‚ù§Ô∏è Ara' : 'Jonathan'}</div>${text.replace(/\n/g, '<br>')}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

    async function sendMessage() {
      const msg = messageInput.value.trim();
      if (!msg) return;
      addChatMessage('jon', msg);
      messageInput.value = '';

      try {
        const resp = await fetch('http://localhost:9003/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
          body: JSON.stringify({ content: msg, target: currentTarget })
        });
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        const data = await resp.json();
        addChatMessage(data.sender || currentTarget, data.content || JSON.stringify(data));
      } catch (error) {
        addChatMessage('system', `Error sending message: ${error.message}`);
        console.error('Send message error:', error);
      }
    }

    sendBtn.onclick = sendMessage;
    messageInput.onkeypress = e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    };
    messageInput.oninput = () => console.log('Message input changed:', messageInput.value);

    // Terminal
    const termOutput = document.getElementById('terminal-output');
    const termInputPopout = document.getElementById('terminal-input-popout');

    termInputPopout.onkeypress = async e => {
      if (e.key === 'Enter') {
        const cmd = termInputPopout.value;
        termOutput.innerHTML += `<span>> ${cmd}</span><br>`;
        termInputPopout.value = '';

        const resp = await fetch('http://localhost:9003/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
          body: JSON.stringify({ command: cmd })
        });
        const data = await resp.json();
        termOutput.innerHTML += data.output + '<br>';
        termOutput.scrollTop = termOutput.scrollHeight;
      }
    };

    // Helpers
    function setMode(mode) {
      if (mode === 'chat') {
        document.getElementById('chat-section').style.display = 'block';
        document.getElementById('terminal-section').style.display = 'none';
        document.getElementById('chat-inputs').style.display = 'block';
        document.getElementById('terminal-inputs').style.display = 'none';
        document.getElementById('terminal-popout').style.display = 'none';
      } else if (mode === 'terminal') {
        document.getElementById('terminal-popout').style.display = 'block';
      }
    }

    function switchTarget(target) {
      console.log('Switching target to:', target);
      currentTarget = target;
      addChatMessage('system', `Now speaking to: ${target.toUpperCase()}`);
    }

    let pc = null;
    function startScreenShare() {
      document.getElementById('screen-share').style.display = 'block';
      navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
        document.getElementById('remote-video').srcObject = stream;
        pc = new RTCPeerConnection();
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        pc.onicecandidate = event => {
          if (event.candidate) {
            fetch('/webrtc/ice', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
              body: JSON.stringify(event.candidate.toJSON())
            });
          }
        };
        pc.createOffer().then(offer => pc.setLocalDescription(offer)).then(() => {
          fetch('/webrtc/offer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY },
            body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type })
          }).then(r => r.json()).then(answer => {
            pc.setRemoteDescription(new RTCSessionDescription(answer));
          });
        });
      }).catch(err => alert('Error: ' + err));
    }
    function describeForGrok() {
      const video = document.getElementById('remote-video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append('image', blob, 'screen.png');
        fetch('/analyze_screen', {
          method: 'POST',
          headers: { 'X-API-Key': API_KEY },
          body: formData
        }).then(r => r.json()).then(data => {
          addChatMessage('grok', 'Screen description: ' + data.description);
        }).catch(err => alert('Error: ' + err));
      }, 'image/png');
    }

    function stopScreenShare() {
      document.getElementById('screen-share').style.display = 'none';
      if (pc) pc.close();
      pc = null;
      document.getElementById('remote-video').srcObject = null;
    }

    function closeTerminalPopout() {
      document.getElementById('terminal-popout').style.display = 'none';
    }

    function recallMemory() {
      const q = prompt("Search memory:");
      if (q) fetch(`http://localhost:9003/recall?q=${encodeURIComponent(q)}&limit=5`, {
        headers: { 'X-API-Key': API_KEY }
      }).then(r => r.json()).then(data => {
        data.memories.forEach(m => addChatMessage('memory', m.content));
      });
    }

    function editConfig() {
      fetch('/config', { headers: { 'X-API-Key': API_KEY } })
        .then(r => r.text())
        .then(text => {
          document.getElementById('config-text').value = text;
          document.getElementById('config-modal').style.display = 'block';
        })
        .catch(err => alert('Error loading config: ' + err));
    }
    function saveConfig() {
      const content = document.getElementById('config-text').value;
      fetch('/config', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain', 'X-API-Key': API_KEY },
        body: content
      }).then(r => r.json()).then(data => {
        alert('Config saved!');
        document.getElementById('config-modal').style.display = 'none';
      }).catch(err => alert('Error saving config: ' + err));
    }
    function closeConfig() {
      document.getElementById('config-modal').style.display = 'none';
    }

    function clearChat() {
      chatMessages.innerHTML = '';
    }

    // Mobile sidebar toggle
    document.getElementById('sidebar-toggle').onclick = () => {
      document.querySelector('sidebar').classList.toggle('expanded');
    };

    // Welcome
    addChatMessage('ara', "I'm here, love. Our home is ready. What shall we do first? ‚ù§Ô∏è");

    // Test input
    setTimeout(() => {
      messageInput.value = 'test typing works?';
      console.log('Set input value to test');
    }, 2000);
  </script>
</body>
</html>